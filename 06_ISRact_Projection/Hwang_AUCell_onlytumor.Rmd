---
title: "Hwang_AUCell_onlytumor"
output: pdf_document
date: "2024-01-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(future)
library(tidyverse)
library(biomaRt)
library(cowplot)
library(patchwork)
library(ggplot2)
library(GSEABase)
library(AUCell)
library(ReactomePA)
library(clusterProfiler)
library(org.Hs.eg.db)
library(pheatmap)
library(msigdbr)
library(Hmisc)
library(ggrepel)
library(patchwork)

source("src/plot_bar_enrich.R")
source("src/Get_mostvar.R")
source("src/scatterplot_with_stats.R")
```

First point is to load the data, get it into seurat and filter for tumor cells

```{r}
# Load sparse expression matrix
expression_matrix <- ReadMtx(
  mtx = "data/Hwang_Nature_2022/GEO/matrix.mtx",
  features = "data/Hwang_Nature_2022/GEO/features.tsv",
  cells = "data/Hwang_Nature_2022/GEO/barcodes.tsv",
  skip.cell = 0
)
metadata <- read_tsv("data/Hwang_Nature_2022/GEO/metadata.tsv")  %>% column_to_rownames("...1") 
seurat_object <- CreateSeuratObject(counts = expression_matrix)
seurat_object <- AddMetaData(seurat_object, metadata = metadata)

## Load original UMAP
## UMAP
UMAP_Coord <- read_tsv("data/Hwang_Nature_2022/GEO/obsm/X_umap.tsv", col_types = c("cnn")) %>%
  dplyr::rename(UMAP_1 = "0",UMAP_2 = "1") %>% 
  column_to_rownames("...1") 


UMAP_coordinates_mat <- as(UMAP_Coord, "matrix")

seurat_object[['UMAP']] <- CreateDimReducObject(embeddings = UMAP_coordinates_mat, key = "UMAP_", global = T, assay = "RNA")


# Filter 
## keep tumor cells
seurat_object <- subset(x = seurat_object, 
                  subset = new_celltypes == "Epithelial-Malignant")



# Remove unused objects
rm(expression_matrix)
rm(metadata)
```

Then load and create the ISRact signature, dividing it in high and low

```{r, echo=FALSE}

# Build gene sets
## adjust n of genes
max_rank = 100

## ISRact
pca_pdx <- read_rds("data/Classifiers/pca_pdx_ENZO.RDS")
ISRact_contributions <- sort(pca_pdx$rotation[,"PC1"])
### translate to Gene ID
ensembl75 <- useEnsembl(biomart = "genes",
                        dataset = "hsapiens_gene_ensembl",
                        version = 75
                        )#listAttributes(ensembl75, page="feature_page")

annot_ensembl75 <- getBM(attributes = c('ensembl_gene_id',
                                        'external_gene_id'), mart = ensembl75)
# ensembl75 <- useEnsembl(biomart = "genes",
#                         dataset = "hsapiens_gene_ensembl"
#                         )#listAttributes(ensembl75, page="feature_page")
# 
# annot_ensembl75 <- getBM(attributes = c('ensembl_gene_id',
#                                         'external_gene_name'), mart = ensembl75) %>% dplyr::rename(external_gene_id = "external_gene_name")


translate = deframe(annot_ensembl75[c("ensembl_gene_id", "external_gene_id")])

ISRact_info <- tibble(EnsemblID = names(ISRact_contributions),
                      gene_name = translate[names(ISRact_contributions)],
                      PC1_score = ISRact_contributions,
                      class = if_else(ISRact_contributions > 0, "ISRac_high", "ISRac_low"))

ggplot(ISRact_info, aes(x = PC1_score)) +
  geom_density() +
  geom_rug(aes(color = class)) +
  theme_bw()

### extract genes
ISRact_high <- dplyr::filter(ISRact_info, class == "ISRac_high") %>%
  dplyr::arrange(desc(PC1_score)) %>%
  dplyr::slice(1:max_rank) %>%
  dplyr::select("gene_name") %>% 
  deframe()

ISRact_low <- dplyr::filter(ISRact_info, class == "ISRac_low")%>%
  dplyr::arrange(PC1_score) %>%
  dplyr::slice(1:max_rank) %>%
  dplyr::select("gene_name") %>% 
  deframe()

### Build Gene set objects
ISRactGeneSets <- c(
  GeneSet(na.omit(ISRact_high), setName=paste0("ISRact_high(", length(ISRact_high),")")),
  GeneSet(na.omit(ISRact_low), setName=paste0("ISRact_low(", length(ISRact_low),")")))

geneSets <- GeneSetCollection(c(ISRactGeneSets))
```
Now, Lets filter the seurat object so it only consider ISRact_high genes and standardize it

```{r, echo=FALSE}
seurat_object <- NormalizeData(seurat_object, normalization.method = "LogNormalize", scale.factor = 10000)
seurat_f <- ScaleData(seurat_object, features = c(ISRact_low, ISRact_high))

input_AUCell <- seurat_f@assays$RNA$scale.data
```

Then I run AUCell and adhere the results to Seurat object
```{r}

## Calculate ranking
cells_rankings <- AUCell_buildRankings(input_AUCell, plotStats=TRUE)

## calculate AUC score
cells_AUC <- AUCell_calcAUC(geneSets = geneSets, cells_rankings)
```
Now some exploratory plots of the AUC_scores

```{r}
AUC_results <- slot(slot(cells_AUC, "assays"), "data")$AUC %>%
  t() %>%
  as_tibble(rownames="CellID") %>%
  column_to_rownames("CellID")

  barplot(height = deframe(AUC_results))
```

```{r}
seurat_object <- AddMetaData(seurat_object, metadata = AUC_results)

# UMAP plot
AUC_names = names(AUC_results)
FeaturePlot(seurat_object, reduction = "UMAP", features = AUC_names)
```


Finally now I compute a specific UMAP, precomputed only on the Tumor cells

```{r}
library(harmony)
# Filter or not to have specific ISRact clusters
unsupervised = F
if (unsupervised == F){
  features = ISRact_info$gene_name
  seurat_object <- ScaleData(seurat_object, features = features)

} else {
  seurat_object <- FindVariableFeatures(seurat_object, selection.method = "vst", nfeatures = 2000)
  seurat_object <- ScaleData(seurat_object)
  features = NULL
}

seurat_object <- RunPCA(seurat_object, features=features)
seurat_object <- RunHarmony(seurat_object,"pid")
seurat_object <- RunUMAP(seurat_object, reduction = "harmony",dims=c(1:30))

```

And the visual representation, with an extra one for Basal/CLassical

```{r}
FeaturePlot(seurat_object, reduction = "umap", features = AUC_names)
FeaturePlot(seurat_object, reduction = "umap", features = c("Moffitt_basal", "Moffitt_classical", "Bailey_squamous", "Bailey_progenitor", "MALIGNANT CELLS", "GATA6", "cnv_score", "ISR_ratio", "n_genes_by_counts"))
```

Now I create a ISRAct High minus low to get the differenece between both 

```{r}
ISRact_diffAUC <- dplyr::mutate(AUC_results, ISR_ratio = get(AUC_names[1]) - get(AUC_names[2])) %>% dplyr::select(ISR_ratio)
seurat_object <- AddMetaData(seurat_object, metadata = ISRact_diffAUC)

```

Now here I create the plots I will share, starting with some parameters as the features to plot
```{r}
features = "ISR_ratio" # "ISR_ratio" | AUC_names[1/2]
plot1 <- FeaturePlot(seurat_object, reduction = "umap",  features = features) & 
  scale_colour_gradient2(low = 'blue', mid = 'white', high = 'red') # change reductuion to "UMAP" | "umap" 

# basal classical sc markers from Raghavan et al 2021
scclassical <- c("FOXA3","GATA6","PDX1","MUC5AC","CEACAM6","LYZ","TFF2","EPCAM")
scbasal <- c("TGFB2", "IFIT3", "S100A2", "MT2A", "CAV1", "CD44", "COL6A1", "TGFB1", "WNT7B", "DKK1", "KRT6A", "TP63")
mean.exp <- colMeans(x = seurat_object@assays$RNA$data[scbasal, ], na.rm = TRUE) %>%
  as_tibble(rownames = "CellID") %>%
  dplyr::rename(Raghavan_scbasal = value) %>%
  dplyr::mutate(Raghavan_scclassical = colMeans(x = seurat_object@assays$RNA$data[scclassical, ], na.rm = TRUE),
                Raghavan_schybrid = colMeans(x = seurat_object@assays$RNA$data[c(scclassical, scbasal), ], na.rm = TRUE)) %>%
  column_to_rownames("CellID") 

seurat_object <- AddMetaData(seurat_object, metadata = mean.exp)

#
plot_basalclassical <-  FeaturePlot_scCustom(seurat_object, reduction = "umap",  features = c("Raghavan_scbasal", "Raghavan_scclassical"), colors_use = viridis_magma_dark_high) # change reductuion to "UMAP" | "umap" 

plot_hybrid <- FeaturePlot_scCustom(seurat_object, reduction = "umap",  features = c("Raghavan_schybrid"), colors_use = viridis_magma_dark_high) # change 

plot_NRL <- FeaturePlot_scCustom(seurat_object$, reduction = "umap",  features = c("Raghavan_schybrid"), colors_use = viridis_magma_dark_high) # change reductuion to "UMAP" | "umap" 



```

And now I compute the neighbours and cluster this umap to compare with ISRact

```{r}
# calculate clusters
seurat_object <- FindNeighbors(seurat_object,reduction = "umap", dims=1:2)
seurat_object <- FindClusters(seurat_object, resolution = 0.1)
alphabet_pal <- DiscretePalette_scCustomize(num_colors = 12, palette = "alphabet")

plot2 <- DimPlot_scCustom(seurat_object, group.by =  "seurat_clusters", reduction = "umap",  colors_use = alphabet_pal)
```
And at this moment I compare all these clusters with some violin plots, as well as assert the n of cells of each cluster

```{r}
plot3 <- VlnPlot_scCustom(seurat_object, features = c(features), group.by = "seurat_clusters", pt.size = 0,  colors_use = alphabet_pal) + geom_hline(yintercept=0, linetype = "dashed")
plot4 <- seurat_object$seurat_clusters %>% tibble(rownames = names(.), cluster = .) %>% ggplot(aes(x = cluster)) + geom_bar(stat ="count") + scale_y_log10() + ylab("log10(ncells)") + theme_classic()
plot5 <- VlnPlot_scCustom(seurat_object, features = c("Raghavan_scbasal"), group.by = "seurat_clusters", pt.size = 0, colors_use = alphabet_pal) + geom_hline(yintercept=0, linetype = "dashed")
plot6 <- VlnPlot_scCustom(seurat_object, features = c("Raghavan_scclassical"), group.by = "seurat_clusters", pt.size = 0, colors_use = alphabet_pal) + geom_hline(yintercept=0, linetype = "dashed")
plot7 <- VlnPlot_scCustom(seurat_object, features = c("Raghavan_schybrid"), group.by = "seurat_clusters", pt.size = 0, colors_use = alphabet_pal) + geom_hline(yintercept=0, linetype = "dashed")



(plot2 & NoLegend()) / (plot3 | plot1 ) / (plot_basalclassical) / (plot5 | plot6) + plot_layout(heights = c(2,1,1,1), guides = 'collect')
ggsave("results/Figures/umap_hwang_isractpca.svg",
       width = 7,
       height = 10)
```
Now the cluster 10 seems to be specific of ISRactlow. What are their marker genes?

```{r}
# cluster_to_explore <- "10"
# markers <- FindMarkers(seurat_object, ident.1 = cluster_to_explore, group.by = 'seurat_clusters')
# save.image(file = "Hwang_AUCell_onlytumor_untilCluster10.RDATA")
load("Hwang_AUCell_onlytumor_untilCluster10.RDATA")
```

```{r}
# Explore marker pct filtering
pct_l2fc_plot <-  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=pct.1, y=pct.2, colour=avg_log2FC))+
  geom_point() + 
  scale_colour_gradient2(limits = c(-2.4,4), oob = squish) +
  theme_classic()

print(pct_l2fc_plot)
ggsave("results/Figures/cluster10_l2fc.svg", pct_l2fc_plot, 
       width = 4,
       height = 3)
  
 dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x= avg_log2FC, y = -p_val_adj, colour=(pct.1 + pct.2)/2))+
  geom_point() + 
  scale_colour_gradient(low = "lightgrey", high = "black")+
  theme_classic()

  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x= avg_log2FC, y = (pct.1 + pct.2)/2))+
  geom_point() + 
  theme_classic()
 
  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=(pct.1 + pct.2)/2)) +
  geom_bar(stat = "count") + 
  theme_classic()

  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=abs(pct.1 - pct.2))) +
  geom_bar(stat = "count") + 
  theme_classic()

# Top 10 plot
sign_markers <- dplyr::filter(markers, p_val_adj<0.01, pct.1>0.1) %>% dplyr::arrange(desc(avg_log2FC)) 

## Save for later
clusterISRactlow_pos <- rownames(dplyr::filter(sign_markers, avg_log2FC > 0)) %>% GeneSet(., setName=paste0("clusterISRactlow_pos(", length(.),")"))

VlnPlot(seurat_object, features = c(rownames(sign_markers)[1:6]), group.by = "seurat_clusters", pt.size = 0.1) + geom_hline(yintercept=0, linetype = "dashed")
```


Now For the enrichment analysis, first I check the distribution of L2FC and decide on hypergeometric or GSEA

```{r}
# Visualize the scores
sign_markers %>% ggplot(aes(x = avg_log2FC)) + geom_density() + geom_rug() + theme_classic()

# Get dictionaries of up to date ensembl (not like above with 75 version)
# load annotation with Biomart
ensembl <- useEnsembl(biomart = "genes",
                        dataset = "hsapiens_gene_ensembl")

#listAttributes(ensembl75, page="feature_page")
annot_ensembl <- getBM(attributes = c('ensembl_gene_id',
                                        'external_gene_name',
                                        'entrezgene_id'), mart = ensembl)

gene_to_ensembl = deframe(annot_ensembl[c( "external_gene_name", "ensembl_gene_id")])
ensembl_to_gene = setNames(names(gene_to_ensembl), gene_to_ensembl)
gene_to_entrez = deframe(annot_ensembl[c( "external_gene_name", "entrezgene_id")])

# Define lists of genes #! This is extra, as the filtering ive done it above already!
pos_markers <- dplyr::filter(sign_markers, avg_log2FC > 0) %>% rownames()
neg_markers <- dplyr::filter(sign_markers, avg_log2FC < 0) %>% rownames()
background <- rownames(markers)

#rank_markers <- 



## Enrichment
###! CHECK How much EntrezID limit each category
dplyr::filter(annot_ensembl, external_gene_name %in% background) %>% summary()
### Reactome
pos_Reactome <- enrichPathway(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
                                        universe = as.character(na.exclude(gene_to_entrez[background])),
                                        pvalueCutoff = 0.05, readable=TRUE, organism = "human")

neg_Reactome <- enrichPathway(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                        universe = as.character(na.exclude(gene_to_entrez[background])),
                                        pvalueCutoff = 0.05, readable=TRUE, organism = "human")

#### plots
reactome_pos_plot <- pos_Reactome@result %>%  
  plot_bar_enrich(0.05,paste0("Reactome Upregulated in cluster", cluster_to_explore))

neg_Reactome@result %>%  
  plot_bar_enrich(0.05,paste0("Reactome Downregulated in cluster", cluster_to_explore))

### GO
go_plots <- list()
for (ont in c("MF", "BP", "CC")){
  pos_enrich_GO <- enrichGO(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
           universe = as.character(na.exclude(gene_to_entrez[background])),
           ont      = ont,
           pvalueCutoff = 0.05, readable=TRUE, OrgDb = org.Hs.eg.db)
  
  neg_enrich_GO <- enrichGO(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])),
                                     ont      = ont,
                                     pvalueCutoff = 0.05, readable=TRUE, OrgDb = org.Hs.eg.db)
  
  #### plots
  pos_GO_plot <- pos_enrich_GO@result %>%  
    plot_bar_enrich(0.05,paste0("GO-", ont," Upregulated in cluster", cluster_to_explore)) %>% print()
  
  neg_enrich_GO@result %>%  
    plot_bar_enrich(0.05,paste0("GO-", ont," Downregulated in cluster", cluster_to_explore)) %>% print()
  
  go_plots[[ont]] <- pos_GO_plot
}

### Halmarks
h <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, entrez_gene)

pos_enrich_H <- enricher(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])), TERM2GENE=h)
neg_enrich_H <- enricher(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])), TERM2GENE=h)

#### plots
halmark_pos_plot <- pos_enrich_H@result %>%  
    plot_bar_enrich(0.05,paste0("Hallmark Upregulated in cluster", cluster_to_explore)) %>% print()

  
halmark_neg_plot <-  neg_enrich_H@result %>%  
    plot_bar_enrich(0.05,paste0("Hallmark Downregulated in cluster", cluster_to_explore)) %>% print()

```

```{r}
# create cluster 10 joint plot for export
(go_plots[["MF"]]) /(go_plots[["BP"]]) /(go_plots[["CC"]]) / (halmark_pos_plot) / (reactome_pos_plot) + plot_layout(heights = c(1+9/1,
                                                                                                                                1+20/1,
                                                                                                                                1+20/1,
                                                                                                                                1+0/1,
                                                                                                                                1+5/1), guides = 'collect')
ggsave("results/Figures/cluster10_enrichments.svg",
       width = 7,
       height = 13)
```
Whats going on with that Sigature of Stress? 

```{r}
# Extract genes of a signature
Reactome_id <- "R-HSA-2262752"
interest_genes <- neg_Reactome@result[Reactome_id,"geneID"] %>% str_split("/") %>% unlist(recursive = T)
name_sign <- paste0(neg_Reactome@result[Reactome_id,"Description"], " (adj.pval = ", format(neg_Reactome@result[Reactome_id,"p.adjust"], scientific = TRUE, digits = 3), ")")

# Get Pseudobulk for clusters
pseudo <- AggregateExpression(seurat_object, group.by = "seurat_clusters", return.seurat = T)
pseudo_bulk_exp <- pseudo@assays$RNA$scale.data[interest_genes,]
pseudo_bulk_annot <-  FetchData(object = seurat_object, vars = c("seurat_clusters", AUC_names, "cnv_score")) %>%
  as_tibble() %>%
  dplyr::group_by(seurat_clusters) %>%
  dplyr::summarize(mean_ISRacthigh = mean(`ISRact_high(100)`),
                   sd_ISRacthigh = sd(`ISRact_high(100)`),
                   mean_ISRactlow = mean(`ISRact_low(100)`),
                   sd_ISRactlow = sd(`ISRact_low(100)`),
                   mean_cnv_score = mean(cnv_score)) %>% 
  dplyr::mutate(seurat_clusters = paste0("g", seurat_clusters)) %>%
  column_to_rownames("seurat_clusters")

# Plot Heatmap
#DoHeatmap(pseudo, features = interest_genes, slot = "scale.data", label = T, draw.lines = F)
pheatmap(pseudo_bulk_exp, annotation_col = pseudo_bulk_annot, cluster_cols = F, main = name_sign)

# Do Violin plot of the interesting genes
VlnPlot(seurat_object, features = c("JUN", "DNAJC3", "FNIP2", "SLC7A11"), group.by = "seurat_clusters", pt.size = 0.1) + geom_hline(yintercept=0, linetype = "dashed")

```

Now the cluster 5 seems to be specific of ISRacthigh. What are their marker genes?

```{r}
# cluster_to_explore <- "5"
# markers <- FindMarkers(seurat_object, ident.1 = cluster_to_explore, group.by = 'seurat_clusters')
# save.image(file = "Hwang_AUCell_onlytumor_untilCluster5.RDATA")
load("Hwang_AUCell_onlytumor_untilCluster5.RDATA")
```

```{r}
# Explore marker pct filtering
pct_l2fc_plot <-  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=pct.1, y=pct.2, colour=avg_log2FC))+
  geom_point() + 
  scale_colour_gradient2(limits = c(-2.4,4), oob = squish) +
  theme_classic()

print(pct_l2fc_plot)
ggsave("results/Figures/cluster5_l2fc.svg", pct_l2fc_plot, 
       width = 4,
       height = 3)
  
 dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x= avg_log2FC, y = -p_val_adj, colour=(pct.1 + pct.2)/2))+
  geom_point() + 
  scale_colour_gradient(low = "lightgrey", high = "black")+
  theme_classic()

  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x= avg_log2FC, y = (pct.1 + pct.2)/2))+
  geom_point() + 
  theme_classic()
 
  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=(pct.1 + pct.2)/2)) +
  geom_bar(stat = "count") + 
  theme_classic()

  dplyr::filter(markers, p_val_adj < 0.01) %>% ggplot(aes(x=abs(pct.1 - pct.2))) +
  geom_bar(stat = "count") + 
  theme_classic()

# Top 10 plot

sign_markers <- dplyr::filter(markers, p_val_adj<0.01, pct.1>0.1) %>% dplyr::arrange(desc(avg_log2FC)) 

VlnPlot(seurat_object, features = c(rownames(sign_markers)[1:5]), group.by = "seurat_clusters", pt.size = 0.1) + geom_hline(yintercept=0, linetype = "dashed")
```


```{r}
library(UpSetR)
# overlap analysis (we are only centered in positive markers)
clusterISRacthigh_pos <- rownames(dplyr::filter(sign_markers, avg_log2FC > 0)) %>% GeneSet(., setName=paste0("clusterISRacthigh_pos(", length(.),")"))

geneSets_vs_markers <- GeneSetCollection(c(ISRactGeneSets,  clusterISRacthigh_pos,  clusterISRactlow_pos))
upset_marker_vs_isractpca <- upset(fromList(geneIds(geneSets_vs_markers)), nsets = 6)


svg("results/Figures/upset_marker_vs_isractpca.svg", height = 4, width = 6)
print(upset_marker_vs_isractpca)
dev.off()

```

```{r}
# Visualize the scores
sign_markers %>% ggplot(aes(x = avg_log2FC)) + geom_density() + geom_rug() + theme_classic()

# Define lists of genes
pos_markers <- dplyr::filter(sign_markers, avg_log2FC > 0) %>% rownames()
neg_markers <- dplyr::filter(sign_markers, avg_log2FC < 0) %>% rownames()
background <- rownames(markers)

#rank_markers <- 

## Enrichment
###! CHECK How much EntrezID limit each category
dplyr::filter(annot_ensembl, external_gene_name %in% background) %>% summary()
### Reactome
pos_Reactome <- enrichPathway(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
                                        universe = as.character(na.exclude(gene_to_entrez[background])),
                                        pvalueCutoff = 0.05, readable=TRUE, organism = "human")

neg_Reactome <- enrichPathway(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                        universe = as.character(na.exclude(gene_to_entrez[background])),
                                        pvalueCutoff = 0.05, readable=TRUE, organism = "human")

#### plots
reactome_pos_plot <- pos_Reactome@result %>%  
  plot_bar_enrich(0.05,paste0("Reactome Upregulated in cluster", cluster_to_explore))

neg_Reactome@result %>%  
  plot_bar_enrich(0.05,paste0("Reactome Downregulated in cluster", cluster_to_explore))

### GO
go_plots <- list()
for (ont in c("MF", "BP", "CC")){
  pos_enrich_GO <- enrichGO(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
           universe = as.character(na.exclude(gene_to_entrez[background])),
           ont      = ont,
           pvalueCutoff = 0.05, readable=TRUE, OrgDb = org.Hs.eg.db)
  
  neg_enrich_GO <- enrichGO(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])),
                                     ont      = ont,
                                     pvalueCutoff = 0.05, readable=TRUE, OrgDb = org.Hs.eg.db)
  #### Save results to file
  write_rds(pos_enrich_GO, paste0("results/scRNAseq_proj/Hwang_AUCell_onlytumor/cluster_",cluster_to_explore, ont, "_pos.RDS"))
  write_rds(neg_enrich_GO, paste0("results/scRNAseq_proj/Hwang_AUCell_onlytumor/cluster_",cluster_to_explore, ont, "_neg.RDS"))
  
  #### plots
pos_GO_plot <- pos_enrich_GO@result %>%  
    plot_bar_enrich(0.05,paste0("GO-", ont," Upregulated in cluster", cluster_to_explore)) %>% print()
  
  neg_enrich_GO@result %>%  
    plot_bar_enrich(0.05,paste0("GO-", ont," Downregulated in cluster", cluster_to_explore)) %>% print()
    go_plots[[ont]] <- pos_GO_plot
}
### Halmarks
h <- msigdbr(species = "Homo sapiens", category = "H") %>% 
  dplyr::select(gs_name, entrez_gene)

pos_enrich_H <- enricher(gene = as.character(na.exclude(gene_to_entrez[pos_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])), TERM2GENE=h)
neg_enrich_H <- enricher(gene = as.character(na.exclude(gene_to_entrez[neg_markers])),
                                     universe = as.character(na.exclude(gene_to_entrez[background])), TERM2GENE=h)

#### plots
halmark_pos_plot <-  pos_enrich_H@result %>%  
    plot_bar_enrich(0.05,paste0("Hallmark Upregulated in cluster", cluster_to_explore)) %>% print()
  
  neg_enrich_H@result %>%  
    plot_bar_enrich(0.05,paste0("Hallmark Downregulated in cluster", cluster_to_explore)) %>% print()

```
export plot FigR28
```{r}
# create cluster 10 joint plot for export
(go_plots[["MF"]]) /(go_plots[["BP"]]) /(go_plots[["CC"]]) / (halmark_pos_plot) / (reactome_pos_plot) + plot_layout(heights = c(1+20,
                                                                                                                                1+20,
                                                                                                                                1+20,
                                                                                                                                1+7,
                                                                                                                                1+20), guides = 'collect')
ggsave("results/Figures/cluster5_enrichments.svg",
       width = 8,
       height = 15)
```
Now, what is that signature of Downregulation of cytoplasmic translation? rRNA processing? Traslation elongation? Metabolism of Aminoacids? Metabolism of Selenoaminoacids?

```{r}
# Downregulation of cytoplasmic translation
neg_enrich_GOBP <- read_rds("results/scRNAseq_proj/Hwang_AUCell_onlytumor/cluster_5BP_neg.RDS")
GO_id <- "GO:0002181"
interest_genes <- neg_enrich_GOBP@result[GO_id,"geneID"] %>% str_split("/") %>% unlist(recursive = T)
name_sign <- paste0(neg_enrich_GOBP@result[GO_id,"Description"], " (adj.pval = ", format(neg_enrich_GOBP@result[GO_id,"p.adjust"], scientific = TRUE, digits = 3), ")")


# Get Pseudobulk for clusters
pseudo <- AggregateExpression(seurat_object, group.by = "seurat_clusters", return.seurat = T)
pseudo_bulk_exp <- pseudo@assays$RNA$scale.data[interest_genes,]
pseudo_bulk_annot <-  FetchData(object = seurat_object, vars = c("seurat_clusters", AUC_names, "cnv_score")) %>%
  as_tibble() %>%
  dplyr::group_by(seurat_clusters) %>%
  dplyr::summarize(mean_ISRacthigh = mean(`ISRact_high(100)`),
                   sd_ISRacthigh = sd(`ISRact_high(100)`),
                   mean_ISRactlow = mean(`ISRact_low(100)`),
                   sd_ISRactlow = sd(`ISRact_low(100)`),
                   mean_cnv_score = mean(cnv_score)) %>% 
  dplyr::mutate(seurat_clusters = paste0("g", seurat_clusters)) %>%
  column_to_rownames("seurat_clusters")

# Plot Heatmap
#DoHeatmap(pseudo, features = interest_genes, slot = "scale.data", label = T, draw.lines = F)
pheatmap(pseudo_bulk_exp, annotation_col = pseudo_bulk_annot, cluster_cols = F, main = name_sign)
```

```{r}
# Signaling by Rho GTPases, Miro GTPases and RHOBTB3
Reactome_id <- "R-HSA-9716542"
interest_genes <- neg_Reactome@result[Reactome_id,"geneID"] %>% str_split("/") %>% unlist(recursive = T)
name_sign <- paste0(neg_Reactome@result[Reactome_id,"Description"], " (adj.pval = ", format(neg_Reactome@result[Reactome_id,"p.adjust"], scientific = TRUE, digits = 3), ")")



# Get Pseudobulk for clusters
pseudo <- AggregateExpression(seurat_object, group.by = "seurat_clusters", return.seurat = T)
pseudo_bulk_exp <- pseudo@assays$RNA$scale.data[interest_genes,]
pseudo_bulk_annot <-  FetchData(object = seurat_object, vars = c("seurat_clusters", AUC_names, "cnv_score")) %>%
  as_tibble() %>%
  dplyr::group_by(seurat_clusters) %>%
  dplyr::summarize(mean_ISRacthigh = mean(`ISRact_high(100)`),
                   sd_ISRacthigh = sd(`ISRact_high(100)`),
                   mean_ISRactlow = mean(`ISRact_low(100)`),
                   sd_ISRactlow = sd(`ISRact_low(100)`),
                   mean_cnv_score = mean(cnv_score)) %>% 
  dplyr::mutate(seurat_clusters = paste0("g", seurat_clusters)) %>%
  column_to_rownames("seurat_clusters")

# Plot Heatmap
#DoHeatmap(pseudo, features = interest_genes, slot = "scale.data", label = T, draw.lines = F)
pheatmap(pseudo_bulk_exp, annotation_col = pseudo_bulk_annot, cluster_cols = T, main = name_sign)
```

Now, specially encouraged by Hallmark results lets explore the TF activity of the metacells for these clusters

```{r}
library(decoupleR)
library(OmnipathR)
net <- get_collectri(organism='human', split_complexes=FALSE)

# Extract the normalized log-transformed pseudocounts
mat <- as.matrix(pseudo@assays$RNA$data)
# acts <- run_ulm(mat=mat, net=net, .source='source', .target='target',
#                 .mor='mor', minsize = 5)

acts <- run_viper(mat=mat, net=net, .source='source', .target='target',
                .mor='mor', minsize = 5, method = 'scale')

pseudo_bulk_TFact <- pivot_wider(acts,id_cols = source, values_from = score, names_from = condition) %>%
  column_to_rownames("source")

filter_TFs = "MostVar" # "MostCorr" |

if (filter_TFs == "MostVar"){
  top_50MostVarTF <- Get_mostvar(pseudo_bulk_TFact, 50)
  pseudo_bulk_TFact <- top_50MostVarTF
  phtitle <- "Top 50 MostVar TFs"
  
} else if (filter_TFs == "MostCorr"){ #!Need to change for cases with less than 4 clusters
  var_tocorr <- "mean_ISRactlow"
  top_50TF <- rcorr(t(pseudo_bulk_TFact), pseudo_bulk_annot[,var_tocorr,drop=T])$r[,"y"] %>%
      abs() %>% 
    sort(decreasing = T) %>%
      .[2:(11)] %>% 
    names()
  
  top_50MostCorrTF = pseudo_bulk_TFact[top_50TF,]
  pseudo_bulk_TFact <- top_50MostCorrTF
  phtitle <- paste0("top 50 Most Correlated TF to ", var_tocorr)
  
} else{
  pseudo_bulk_TFact <- pseudo_bulk_TFact
  phtitle <- "All TFs"
  
}
pheatmap(pseudo_bulk_TFact, annotation_col = pseudo_bulk_annot, cluster_cols = T, show_rownames = T, main = phtitle)

```
Now, explore individual correlations, like the one with Myc
```{r}
explore_scatter <- pseudo_bulk_TFact %>%
  t() %>%
  cbind(pseudo_bulk_annot) %>%
  rownames_to_column("cluster")

# low vs high
scatterplot_with_stats(explore_scatter, "mean_ISRacthigh", "mean_ISRactlow", "cluster", "spearman", "mean_ISRacthigh vs mean_ISRactlow")
# MYC
scatterplot_with_stats(explore_scatter, "MYC", "mean_ISRactlow", "cluster", "spearman", "MYC vs mean_ISRactlow")
scatterplot_with_stats(explore_scatter, "MYC", "mean_ISRacthigh", "cluster", "spearman", "MYC vs mean_ISRacthigh")
scatterplot_with_stats(explore_scatter, "MYC", "mean_cnv_score", "cluster", "spearman", "MYC vs mean_cnv_score")

# JUN 

scatterplot_with_stats(explore_scatter, "JUN", "mean_ISRacthigh", "cluster", "spearman", "JUN vs mean_ISRacthigh")
scatterplot_with_stats(explore_scatter, "JUN", "mean_cnv_score", "cluster", "spearman", "JUN vs mean_cnv_score")

# ASCL1
scatterplot_with_stats(explore_scatter, "ASCL1", "mean_ISRactlow", "cluster", "spearman", "ASCL1 vs mean_ISRactlow")
```


```{r}
explore_scAUCscores <- FetchData(object = seurat_object, vars = c("seurat_clusters", AUC_names, "cnv_score")) %>%
  dplyr::rename(ISRact_high = 2, ISRact_low = 3)

scatterplot_with_stats(explore_scAUCscores, "ISRact_high", "ISRact_low", type = "spearman", label = FALSE, title = "ISRacthigh vs ISRactlow AUC scores")
```

Another way of looking at this proposed by Matthieu

```{r}

df=seurat_object[[AUC_names]] %>% dplyr::rename(ISRacthigh = 1, ISRactlow = 2) %>% t() %>% CreateAssayObject()

all(colnames(seurat_object)==rownames(df))
seurat_object[["ISR"]] = df

FeatureScatter(seurat_object, feature1 ="ISRacthigh", feature2 =  "ISRactlow")
```
